<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(쇠창살) 임펠다운 수감자 관리부 (수갑)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #111827; 
            color: #d1d5db; 
        }
        .container {
            max-width: 1280px; 
            margin: 1rem auto;
            padding: 1rem;
            background-color: #1f2937; 
            border-radius: 0.75rem; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
        }
        .form-input {
            background-color: #4b5563; /* Slightly lighter for better visibility */
            border: 1px solid #6b7280; /* Added border */
            color: #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.6rem 0.75rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input:focus {
            border-color: #60a5fa; 
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
            outline: none;
        }
        .form-input::placeholder {
            color: #9ca3af;
        }
        /* Date input text color */
        input[type="date"] {
            color-scheme: dark; /* Ensures date picker is also dark themed if browser supports */
        }
        .btn {
            font-weight: 600; 
            padding: 0.65rem 1.3rem; 
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .btn-primary {
            background-color: #3b82f6; 
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-danger {
            background-color: #ef4444; 
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background-color: #4b5563; 
            color: #e5e7eb;
        }
        .btn-secondary:hover {
            background-color: #374151;
            transform: translateY(-1px);
        }
        .prison-tower {
            width: 190px; 
            min-height: 420px; 
            background: linear-gradient(to bottom, #4a5568, #374151); 
            border: 2px solid #6b7280; 
            border-radius: 8px;
            margin: 15px auto; 
            display: flex;
            flex-direction: column; 
            position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .floor {
            flex-grow: 1;
            border-bottom: 1px solid #4b5563; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #d1d5db;
            position: relative; 
            padding: 7px 0; 
            font-size: 0.85rem; 
            transition: background-color 0.2s;
        }
        .floor[data-level]:hover { /* Style for clickable floors */
            background-color: #4b5563;
            cursor: pointer;
        }
        .prison-tower .floor:last-child { 
             border-bottom: none; 
        }
        .floor.top-surface { 
            background-color: #6b7280;
            color: #111827;
            border-bottom: 2px solid #374151; 
            flex-grow: 0.35; 
            font-size: 0.9rem;
        }
        #levelArrow {
            position: absolute;
            left: -28px; 
            font-size: 1.6rem; 
            color: #f87171; 
            transition: top 0.5s ease-in-out, opacity 0.3s;
            display: none; 
            z-index: 10;
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        #championImageIndicator {
            position: absolute;
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border: 2px solid #60a5fa; 
            box-shadow: 0 3px 7px rgba(0,0,0,0.2); 
            transition: top 0.5s ease-in-out, opacity 0.3s;
            display: none; 
            object-fit: cover;
            z-index: 10;
            background-color: #374151; 
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
            backdrop-filter: blur(3px);
        }
        .modal-content, .roster-modal-content { /* Combined common styles */
            background-color: #1f2937; 
            padding: 25px;
            border-radius: 0.75rem;
            color: #d1d5db;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        .modal-content { /* Specific to simple confirm/alert modal */
             max-width: 450px;
             text-align: center;
        }
        .roster-modal-content { /* Specific to roster/floor inmates modal */
            max-width: 800px; 
            max-height: 80vh;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        #searchResults {
            background-image: url('https://raw.githubusercontent.com/JungleKing95/Audiofile/main/cxu6RfftaRe5vnuR72qp7Ub17uwp5Z6jcWQrxEkiw3vwVUo55ekX_wLDvp_w5aNPIOVWpqsnY5s69JRMbTVu4w.jpg');
            background-size: cover;
            background-position: center;
            position: relative; 
            border-radius: 0.75rem;
            overflow: hidden; 
        }
        #searchResults::before { 
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(31, 41, 55, 0.65); 
            z-index: 1; 
        }
        #searchResults > * { 
            position: relative;
            z-index: 2;
        }
        .audio-controls {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background-color: rgba(31, 41, 53, 0.85);
            padding: 10px 12px;
            border-radius: 50px; 
            z-index: 1001;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .audio-controls button {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.1rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .audio-controls button:hover {
            color: #e5e7eb;
        }
        .card {
            background-color: #374151; 
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .section-title {
            font-size: 1.25rem; 
            font-weight: 600;
            color: #93c5fd; 
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        .section-title i {
            margin-right: 0.5rem;
        }
        .roster-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .roster-table th, .roster-table td {
            border: 1px solid #4b5563;
            padding: 8px 10px;
            text-align: left;
            font-size: 0.9rem;
        }
        .roster-table th {
            background-color: #374151;
            color: #93c5fd;
        }
        .multiple-results-item {
            padding: 0.5rem;
            border-bottom: 1px solid #4b5563;
        }
        .multiple-results-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container mx-auto">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-400 flex items-center justify-center">
                <i class="fas fa-border-all mr-3 text-3xl"></i>
                임펠다운 수감자 관리부
                <i class="fas fa-handcuffs ml-3 text-3xl"></i>
            </h1>
            <div class="absolute top-0 right-0 flex space-x-2 mt-1 mr-1">
                <button id="viewRosterBtn" class="btn btn-secondary text-xs"><i class="fas fa-list-alt mr-1"></i>전체 명단</button>
                <button id="dbInfoBtn" class="btn btn-secondary text-xs"><i class="fas fa-database mr-1"></i>DB 정보</button>
            </div>
            <input type="hidden" id="editingDocId" value="">
        </header>

        <div class="flex flex-col md:flex-row md:space-x-6 mb-8">
            <section id="registration" class="md:w-1/2 mb-6 md:mb-0 p-5 card">
                <h2 id="formTitle" class="section-title"><i class="fas fa-user-plus"></i>수감자 등록</h2>
                <form id="addPrisonerForm" class="space-y-4">
                    <div>
                        <label for="personInfo" class="block text-sm font-medium text-gray-400 mb-1">사람 정보:</label>
                        <input type="text" id="personInfo" name="personInfo" required class="form-input block w-full text-sm">
                    </div>
                    <div>
                        <label for="championInfo" class="block text-sm font-medium text-gray-400 mb-1">사용 챔피언:</label>
                        <input type="text" id="championInfo" name="championInfo" required class="form-input block w-full text-sm">
                    </div>
                    <div>
                        <label for="opggScore" class="block text-sm font-medium text-gray-400 mb-1">OP.GG SCORE:</label>
                        <input type="number" id="opggScore" name="opggScore" step="0.01" min="0" max="2.79" required class="form-input block w-full text-sm">
                    </div>
                    <div>
                        <label for="kda" class="block text-sm font-medium text-gray-400 mb-1">K/D/A:</label>
                        <input type="text" id="kda" name="kda" class="form-input block w-full text-sm">
                    </div>
                    <div id="imprisonmentDateDiv" class="hidden">
                        <label for="imprisonmentDateEdit" class="block text-sm font-medium text-gray-400 mb-1">수감 시작일 (수정 시):</label>
                        <input type="date" id="imprisonmentDateEdit" name="imprisonmentDateEdit" class="form-input block w-full text-sm">
                    </div>
                    <div class="flex space-x-3 pt-2">
                        <button type="submit" id="submitBtn" class="btn btn-primary w-full text-sm"><i class="fas fa-save mr-2"></i>수감 등록</button>
                        <button type="button" id="cancelEditBtn" class="btn btn-secondary w-full text-sm hidden"><i class="fas fa-times mr-2"></i>취소</button>
                    </div>
                </form>
            </section>

            <section id="search" class="md:w-1/2 p-5 card">
                <h2 class="section-title"><i class="fas fa-search"></i>수감자 정보 조회</h2>
                <form id="searchPrisonerForm" class="space-y-4">
                    <div>
                        <label for="searchPersonInfo" class="block text-sm font-medium text-gray-400 mb-1">사람 정보 (선택):</label>
                        <input type="text" id="searchPersonInfo" name="searchPersonInfo" class="form-input block w-full text-sm">
                    </div>
                    <div>
                        <label for="searchChampionInfo" class="block text-sm font-medium text-gray-400 mb-1">사용 챔피언 (선택):</label>
                        <input type="text" id="searchChampionInfo" name="searchChampionInfo" class="form-input block w-full text-sm">
                    </div>
                    <button type="submit" class="btn btn-primary w-full text-sm mt-10"><i class="fas fa-binoculars mr-2"></i>정보 조회</button> 
                </form>
            </section>
        </div>

        <section id="searchResults" class="p-5 md:p-6 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold mb-4 text-blue-300"><i class="fas fa-gavel mr-2"></i>조회 결과</h2>
            <div id="statusMessage" class="mb-5 text-lg min-h-[45px] p-3 bg-gray-900 bg-opacity-70 rounded-md text-center">조회할 수감자 정보를 입력해주세요.</div>
            <div class="flex flex-col md:flex-row justify-around items-start md:items-center gap-6">
                <div id="prisonerDetails" class="md:w-3/5 w-full">
                    <h3 class="text-xl font-semibold mb-2 text-blue-200">수감자 상세 정보:</h3>
                    <div id="detailsContent" class="text-gray-200 space-y-1.5 text-sm p-4 bg-gray-900 bg-opacity-70 rounded-md shadow-md"></div>
                    <div id="actionsBar" class="mt-4 space-x-2 flex"></div>
                </div>
                <div class="md:w-2/5 w-full flex justify-center items-center">
                     <div id="prisonTowerVisual" class="prison-tower">
                        <div class="floor top-surface">지상</div> 
                        <div class="floor" data-level="5">B5</div>
                        <div class="floor" data-level="10">B10</div>
                        <div class="floor" data-level="30">B30</div>
                        <div class="floor" data-level="50">B50</div>
                        <div class="floor" data-level="100">B100</div>
                        <div id="levelArrow">➔</div>
                        <img id="championImageIndicator" src="https://placehold.co/40x40/transparent/transparent?text=" alt="챔피언 이미지">
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="customModal" class="modal hidden">
        <div class="modal-content">
            <p id="modalMessageText" class="mb-5 text-base"></p>
            <div class="flex justify-end space-x-3">
                <button id="modalConfirmButton" class="btn btn-primary">확인</button>
                <button id="modalCancelButton" class="btn btn-secondary">취소</button>
            </div>
        </div>
    </div>
    
    <div id="rosterModal" class="modal hidden">
        <div class="roster-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-blue-300"><i class="fas fa-users mr-2"></i>전체 수감자 명단</h2>
                <button id="closeRosterModalBtn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="rosterTableContainer">
                <p>명단을 불러오는 중입니다...</p>
            </div>
        </div>
    </div>

    <div id="floorInmatesModal" class="modal hidden">
        <div class="roster-modal-content"> <div class="flex justify-between items-center mb-4">
                <h2 id="floorInmatesTitle" class="text-xl font-semibold text-blue-300">층별 수감자 명단</h2>
                <button id="closeFloorInmatesModalBtn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="floorInmatesTableContainer">
                <p>명단을 불러오는 중입니다...</p>
            </div>
        </div>
    </div>


    <audio id="backgroundMusic" loop src="https://raw.githubusercontent.com/JungleKing95/Audiofile/main/oneP.mp3"></audio>
    <div class="audio-controls">
        <button id="playPauseBtn"><i class="fas fa-play"></i></button>
    </div>

    <script type="module">
        // Firebase SDK imports - Updated to 11.8.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, Timestamp, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js"; // Added Analytics

        // Your web app's Firebase configuration - Updated with provided values
        const firebaseConfig = {
          apiKey: "AIzaSyAHTf1p7tsHHC_FywDu04JORxnRLuvTaiQ",
          authDomain: "impeldown-f29a5.firebaseapp.com",
          projectId: "impeldown-f29a5",
          storageBucket: "impeldown-f29a5.appspot.com", 
          messagingSenderId: "419055960527",
          appId: "1:419055960527:web:0ceeace20d5c50619d12ba",
          measurementId: "G-1SHEZVQZXT"
        };
        
        const appId = firebaseConfig.appId; 

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); 
        const auth = getAuth(app);
        const db = getFirestore(app);
        // setLogLevel('debug'); 

        let userId = null; 
        let prisonersCollectionRef = null;
        let publicRosterCollectionRef = null;


        const el = (id) => document.getElementById(id);
        const addPrisonerForm = el('addPrisonerForm');
        const searchPrisonerForm = el('searchPrisonerForm');
        const statusMessage = el('statusMessage');
        const prisonerDetailsContent = el('detailsContent');
        const levelArrow = el('levelArrow');
        const championImageEl = el('championImageIndicator');
        const formTitle = el('formTitle');
        const submitBtn = el('submitBtn');
        const cancelEditBtn = el('cancelEditBtn');
        const editingDocIdInput = el('editingDocId');
        const actionsBar = el('actionsBar');
        const dbInfoBtn = el('dbInfoBtn');
        const viewRosterBtn = el('viewRosterBtn');
        const rosterModal = el('rosterModal');
        const closeRosterModalBtn = el('closeRosterModalBtn');
        const rosterTableContainer = el('rosterTableContainer');
        const imprisonmentDateDiv = el('imprisonmentDateDiv');
        const imprisonmentDateEditInput = el('imprisonmentDateEdit');
        
        const floorInmatesModal = el('floorInmatesModal');
        const floorInmatesTitle = el('floorInmatesTitle');
        const closeFloorInmatesModalBtn = el('closeFloorInmatesModalBtn');
        const floorInmatesTableContainer = el('floorInmatesTableContainer');

        const customModal = el('customModal');
        const modalMessageText = el('modalMessageText');
        const modalConfirmButton = el('modalConfirmButton');
        const modalCancelButton = el('modalCancelButton');

        const backgroundMusic = el('backgroundMusic');
        const playPauseBtn = el('playPauseBtn');
        const playIcon = '<i class="fas fa-play"></i>';
        const pauseIcon = '<i class="fas fa-pause"></i>';

        function showDialog(message, onConfirmCallback = null, showCancel = false, confirmText = "확인", cancelText = "취소") {
            modalMessageText.textContent = message;
            modalConfirmButton.textContent = confirmText;
            modalConfirmButton.onclick = () => {
                customModal.classList.add('hidden');
                if (onConfirmCallback) onConfirmCallback();
            };

            if (showCancel) {
                modalCancelButton.textContent = cancelText;
                modalCancelButton.classList.remove('hidden');
                modalCancelButton.onclick = () => customModal.classList.add('hidden');
            } else {
                modalCancelButton.classList.add('hidden');
            }
            customModal.classList.remove('hidden');
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User authenticated. UID:", userId);
            } else {
                const randomId = crypto.randomUUID();
                userId = `unauthenticated-${randomId}`; 
                console.warn("User is not authenticated. Using temporary ID:", userId);
            }
            prisonersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/prisoners`);
            publicRosterCollectionRef = collection(db, `artifacts/${appId}/public/data/impel_down_roster`); 
        });
        
        async function attemptSignIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting sign in with custom token (Canvas environment).");
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Successfully signed in with custom token.");
                } else {
                    console.log("No custom token found (expected for external hosting), attempting anonymous sign in.");
                    await signInAnonymously(auth);
                    console.log("Successfully signed in anonymously.");
                }
            } catch (error) {
                console.warn("Initial authentication attempt failed:", error.code, error.message);
                if ((typeof __initial_auth_token !== 'undefined' && __initial_auth_token) &&
                    (error.code === 'auth/custom-token-mismatch' || error.code === 'auth/invalid-custom-token')) {
                    
                    console.log("Custom token failed for external config, explicitly falling back to anonymous sign-in.");
                    try {
                        await signInAnonymously(auth);
                        console.log("Successfully signed in anonymously after custom token failure.");
                    } catch (anonError) {
                        console.error("Fallback anonymous sign-in also failed:", anonError.code, anonError.message);
                        showDialog(`인증 오류: ${anonError.message}. 앱 사용이 제한될 수 있습니다.`);
                    }
                } else {
                    console.error("Unhandled authentication error or primary anonymous sign-in failure:", error.code, error.message);
                    showDialog(`인증 오류: ${error.message}. 앱 사용이 제한될 수 있습니다.`);
                }
            }
        }
        attemptSignIn();

        const prisonLevels = [5, 10, 30, 50, 100]; 

        function getPrisonTerms(score) {
            if (score >= 0 && score < 1.5) return { durationDays: 100, prisonLevel: 100 };
            if (score >= 1.5 && score < 1.8) return { durationDays: 50, prisonLevel: 50 };
            if (score >= 1.8 && score < 2.2) return { durationDays: 30, prisonLevel: 30 };
            if (score >= 2.2 && score < 2.5) return { durationDays: 20, prisonLevel: 10 };
            if (score >= 2.5 && score < 2.8) return { durationDays: 10, prisonLevel: 5 };
            return null; 
        }

        function getTermsForLevel(level) {
            if (level === 5) return { durationDays: 10, prisonLevel: 5 };
            if (level === 10) return { durationDays: 20, prisonLevel: 10 };
            if (level === 30) return { durationDays: 30, prisonLevel: 30 };
            if (level === 50) return { durationDays: 50, prisonLevel: 50 };
            if (level === 100) return { durationDays: 100, prisonLevel: 100 };
            return { durationDays: 100, prisonLevel: 100 }; 
        }

        function getNextLowerLevel(currentLevel) {
            const currentIndex = prisonLevels.indexOf(currentLevel);
            if (currentIndex === -1 || currentIndex === prisonLevels.length - 1) {
                return 100; 
            }
            return prisonLevels[currentIndex + 1];
        }
        
        async function syncToPublicRoster(docId, prisonerData, isDelete = false) {
            if (!publicRosterCollectionRef) {
                console.error("Public roster collection not initialized.");
                return;
            }
            const publicDocRef = doc(publicRosterCollectionRef, docId); 
            try {
                if (isDelete) {
                    await deleteDoc(publicDocRef);
                } else {
                    const publicData = {
                        personInfo: prisonerData.personInfo,
                        championInfo: prisonerData.championInfo,
                        opggScore: prisonerData.opggScore,
                        kda: prisonerData.kda,
                        imprisonmentDate: prisonerData.imprisonmentDate, 
                        durationDays: prisonerData.durationDays,
                        prisonLevel: prisonerData.prisonLevel,
                        originalCreatorId: prisonerData.userId 
                    };
                    await setDoc(publicDocRef, publicData); 
                }
            } catch (error) {
                console.error("Error syncing to public roster: ", error);
            }
        }

        addPrisonerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId || !prisonersCollectionRef) {
                showDialog("사용자 인증이 진행중이거나 실패했습니다. 잠시 후 다시 시도해주세요.");
                return;
            }

            const personInfo = addPrisonerForm.personInfo.value.trim();
            const championInfo = addPrisonerForm.championInfo.value.trim();
            const opggScore = parseFloat(addPrisonerForm.opggScore.value);
            const kda = addPrisonerForm.kda.value.trim();
            const editingDocId = editingDocIdInput.value;

            if (editingDocId) { 
                const terms = getPrisonTerms(opggScore); 
                if (!terms) {
                    showDialog("OP.GG SCORE가 유효한 범위 (0.0 ~ 2.79)에 있지 않습니다.");
                    return;
                }
                
                const docRef = doc(prisonersCollectionRef, editingDocId);
                const existingDocSnap = await getDoc(docRef);
                const existingData = existingDocSnap.data();

                let newImprisonmentDate = existingData.imprisonmentDate; // Default to existing
                if (imprisonmentDateEditInput.value) {
                    // Ensure the date string is treated as local date, not UTC, to avoid timezone shifts
                    const dateParts = imprisonmentDateEditInput.value.split('-');
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                    const day = parseInt(dateParts[2]);
                    newImprisonmentDate = Timestamp.fromDate(new Date(year, month, day));
                }


                const updatedData = { 
                    personInfo, championInfo, opggScore, kda,
                    prisonLevel: terms.prisonLevel,
                    durationDays: terms.durationDays,
                    imprisonmentDate: newImprisonmentDate, 
                    userId: existingData.userId 
                };

                try {
                    await updateDoc(docRef, updatedData);
                    await syncToPublicRoster(editingDocId, updatedData); 
                    showDialog(`${personInfo} (${championInfo}) 정보가 성공적으로 수정되었습니다.`);
                    resetFormToRegisterMode();
                    clearSearchResults(); 
                } catch (error) {
                    console.error("Error updating document: ", error);
                    showDialog(`정보 수정 중 오류 발생: ${error.message}`);
                }
            } else { 
                const q = query(prisonersCollectionRef, where("personInfo", "==", personInfo), where("championInfo", "==", championInfo));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) { 
                    const existingDoc = querySnapshot.docs[0];
                    const currentLevel = existingDoc.data().prisonLevel;
                    const newLevel = getNextLowerLevel(currentLevel);
                    const newTerms = getTermsForLevel(newLevel);

                    const reoffenderData = { 
                        personInfo, championInfo, opggScore, kda, 
                        imprisonmentDate: Timestamp.fromDate(new Date()), 
                        prisonLevel: newTerms.prisonLevel,
                        durationDays: newTerms.durationDays,
                        userId 
                    };
                    try {
                        await updateDoc(doc(prisonersCollectionRef, existingDoc.id), reoffenderData);
                        await syncToPublicRoster(existingDoc.id, reoffenderData);
                        showDialog(`${personInfo} (${championInfo}) 재수감 처리 완료. 지하 ${newTerms.prisonLevel}층으로 강등 및 형기 재시작.`);
                        addPrisonerForm.reset();
                    } catch (error)
                     {
                        console.error("Error updating re-offender: ", error);
                        showDialog(`재수감 처리 중 오류: ${error.message}`);
                    }
                } else { 
                    const terms = getPrisonTerms(opggScore);
                    if (!terms) {
                        showDialog("OP.GG SCORE가 유효한 범위 (0.0 ~ 2.79)에 있지 않습니다.");
                        return;
                    }
                    const newPrisonerData = { 
                        personInfo, championInfo, opggScore, kda,
                        imprisonmentDate: Timestamp.fromDate(new Date()),
                        durationDays: terms.durationDays,
                        prisonLevel: terms.prisonLevel,
                        userId 
                    };
                    try {
                        const newDocRef = await addDoc(prisonersCollectionRef, newPrisonerData);
                        await syncToPublicRoster(newDocRef.id, newPrisonerData); 
                        showDialog(`수감자 ${personInfo} (${championInfo}) 정보가 성공적으로 등록되었습니다.`);
                        addPrisonerForm.reset();
                    } catch (error) {
                        console.error("Error adding document: ", error);
                        showDialog(`수감자 정보 등록 중 오류 발생: ${error.message}`);
                    }
                }
            }
        });

        function formatDate(dateObj) {
            if (!dateObj) return 'N/A';
            if (dateObj.toDate) dateObj = dateObj.toDate(); // Convert Firestore Timestamp to JS Date
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}년 ${month}월 ${day}일`;
        }
        
        // Function to format JS Date to YYYY-MM-DD for date input
        function formatDateForInput(dateObj) {
            if (!dateObj) return '';
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }


        function updatePrisonTowerView(level, championName = null) {
            levelArrow.style.display = 'none'; 
            championImageEl.classList.add('hidden');
            championImageEl.src = 'https://placehold.co/40x40/transparent/transparent?text='; 

            const targetFloorDiv = Array.from(el('prisonTowerVisual').querySelectorAll('.floor[data-level]'))
                                      .find(floorDiv => parseInt(floorDiv.dataset.level) === level);

            if (targetFloorDiv) {
                const towerRect = el('prisonTowerVisual').getBoundingClientRect();
                const floorRect = targetFloorDiv.getBoundingClientRect();
                const indicatorTopPosition = (floorRect.top + floorRect.height / 2) - towerRect.top;

                levelArrow.style.top = `${indicatorTopPosition - (levelArrow.offsetHeight / 2)}px`;
                levelArrow.style.display = 'block';

                if (championName) {
                    const ddragonVersion = "14.10.1"; 
                    const championKey = championName.replace(/[^a-zA-Z0-9]/g, ''); 

                    championImageEl.src = `https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/img/champion/${championKey}.png`;
                    championImageEl.alt = `${championName} 이미지`;
                    championImageEl.onerror = () => {
                        championImageEl.src = 'https://placehold.co/40x40/374151/9ca3af?text=?'; 
                        championImageEl.alt = '이미지 없음';
                    };
                    
                    championImageEl.style.top = `${indicatorTopPosition - (championImageEl.offsetHeight / 2)}px`;
                    const arrowLeftPx = parseInt(window.getComputedStyle(levelArrow).left); 
                    const arrowWidthPx = levelArrow.offsetWidth; 
                    championImageEl.style.left = `${arrowLeftPx + arrowWidthPx + 5}px`; 
                    championImageEl.classList.remove('hidden');
                }
            }
        }
        
        searchPrisonerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId || !prisonersCollectionRef) {
                showDialog("사용자 인증이 진행중이거나 실패했습니다.");
                return;
            }

            const searchPerson = searchPrisonerForm.searchPersonInfo.value.trim();
            const searchChampion = searchPrisonerForm.searchChampionInfo.value.trim();
            
            clearSearchResults();

            if (!searchPerson && !searchChampion) {
                statusMessage.textContent = "검색어를 하나 이상 입력해주세요.";
                showDialog("사람 정보 또는 사용 챔피언 중 하나 이상을 입력하여 검색해주세요.");
                return;
            }
            
            statusMessage.textContent = "수감자 정보를 검색 중입니다...";
            
            let queryConstraints = [];
            if (searchPerson) {
                queryConstraints.push(where("personInfo", "==", searchPerson));
            }
            if (searchChampion) {
                queryConstraints.push(where("championInfo", "==", searchChampion));
            }

            try {
                const q = query(prisonersCollectionRef, ...queryConstraints);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    statusMessage.textContent = "일치하는 수감 정보를 찾을 수 없습니다.";
                    return;
                }

                if (querySnapshot.docs.length === 1) {
                    const prisonerDoc = querySnapshot.docs[0];
                    const prisoner = prisonerDoc.data();
                    prisoner.id = prisonerDoc.id; 

                    const imprisonmentDate = prisoner.imprisonmentDate?.toDate();
                    if (!imprisonmentDate) { 
                         statusMessage.textContent = "수감일 정보가 없어 상태를 표시할 수 없습니다.";
                         prisonerDetailsContent.innerHTML = '';
                         return;
                    }
                    const releaseDate = new Date(imprisonmentDate.getTime());
                    releaseDate.setDate(imprisonmentDate.getDate() + prisoner.durationDays);

                    const today = new Date();
                    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const releaseDateOnly = new Date(releaseDate.getFullYear(), releaseDate.getMonth(), releaseDate.getDate());

                    let currentStatus = "";
                    if (todayDateOnly > releaseDateOnly) {
                        currentStatus = `${formatDate(releaseDate)} 자로 석방됨.`;
                        levelArrow.style.display = 'none'; 
                        championImageEl.classList.add('hidden');
                    } else {
                        currentStatus = `${formatDate(releaseDate)} 자로 석방 예정. 현재 지하 ${prisoner.prisonLevel}층 수감.`;
                        updatePrisonTowerView(prisoner.prisonLevel, prisoner.championInfo);
                    }
                    statusMessage.textContent = currentStatus;

                    prisonerDetailsContent.innerHTML = `
                        <p><strong>이름/소환사명:</strong> ${prisoner.personInfo}</p>
                        <p><strong>사용 챔피언:</strong> ${prisoner.championInfo}</p>
                        <p><strong>OP.GG Score:</strong> ${prisoner.opggScore}</p>
                        <p><strong>K/D/A:</strong> ${prisoner.kda || 'N/A'}</p>
                        <p><strong>수감 시작일:</strong> ${formatDate(imprisonmentDate)}</p>
                        <p><strong>수감 기간:</strong> ${prisoner.durationDays}일</p>
                        <p><strong>배정 층수:</strong> 지하 ${prisoner.prisonLevel}층</p>
                    `;
                    renderActionButtons(prisoner);
                } else { // Multiple results
                    statusMessage.textContent = `${querySnapshot.docs.length}명의 수감자 정보가 검색되었습니다. (개인 데이터 기준)`;
                    let resultsHTML = '<div class="space-y-2">';
                    const today = new Date();
                    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                    querySnapshot.forEach(docSnap => {
                        const prisoner = docSnap.data();
                        const imprisonmentDate = prisoner.imprisonmentDate?.toDate();
                        let currentStatus = "상태 정보 없음";
                        if(imprisonmentDate){
                            const releaseDate = new Date(imprisonmentDate.getTime());
                            releaseDate.setDate(imprisonmentDate.getDate() + prisoner.durationDays);
                            const releaseDateOnly = new Date(releaseDate.getFullYear(), releaseDate.getMonth(), releaseDate.getDate());
                             if (todayDateOnly > releaseDateOnly) {
                                currentStatus = `${formatDate(releaseDate)} 석방됨.`;
                            } else {
                                currentStatus = `${formatDate(releaseDate)} 석방 예정 (B${prisoner.prisonLevel}층)`;
                            }
                        }
                        resultsHTML += `
                            <div class="multiple-results-item">
                                <p><strong>이름:</strong> ${prisoner.personInfo}, <strong>챔피언:</strong> ${prisoner.championInfo}</p>
                                <p><strong>상태:</strong> ${currentStatus}</p>
                            </div>`;
                    });
                    resultsHTML += '</div>';
                    prisonerDetailsContent.innerHTML = resultsHTML;
                    actionsBar.innerHTML = ''; // No actions for multiple results view
                    levelArrow.style.display = 'none'; 
                    championImageEl.classList.add('hidden');
                }

            } catch (error) {
                console.error("Error searching document: ", error);
                statusMessage.textContent = "정보 조회 중 오류 발생.";
            }
        });

        function renderActionButtons(prisoner) {
            actionsBar.innerHTML = ''; 
            
            const editButton = document.createElement('button');
            editButton.innerHTML = '<i class="fas fa-edit mr-1"></i>수정';
            editButton.classList.add('btn', 'btn-secondary', 'text-xs', 'flex-1');
            editButton.onclick = () => setupEditMode(prisoner);
            actionsBar.appendChild(editButton);

            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '<i class="fas fa-trash-alt mr-1"></i>삭제';
            deleteButton.classList.add('btn', 'btn-danger', 'text-xs', 'flex-1');
            deleteButton.onclick = () => confirmDeletePrisoner(prisoner);
            actionsBar.appendChild(deleteButton);
        }

        function setupEditMode(prisoner) {
            formTitle.innerHTML = '<i class="fas fa-user-edit"></i>수감자 정보 수정';
            submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>정보 수정';
            cancelEditBtn.classList.remove('hidden');
            
            addPrisonerForm.personInfo.value = prisoner.personInfo;
            addPrisonerForm.championInfo.value = prisoner.championInfo;
            addPrisonerForm.opggScore.value = prisoner.opggScore;
            addPrisonerForm.kda.value = prisoner.kda || '';
            editingDocIdInput.value = prisoner.id;

            // Populate and show imprisonment date input
            const currentImprisonmentDate = prisoner.imprisonmentDate?.toDate();
            imprisonmentDateEditInput.value = formatDateForInput(currentImprisonmentDate);
            imprisonmentDateDiv.classList.remove('hidden');


            el('registration').scrollIntoView({ behavior: 'smooth' });
        }

        cancelEditBtn.addEventListener('click', resetFormToRegisterMode);

        function resetFormToRegisterMode() {
            formTitle.innerHTML = '<i class="fas fa-user-plus"></i>수감자 등록';
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>수감 등록';
            cancelEditBtn.classList.add('hidden');
            addPrisonerForm.reset();
            editingDocIdInput.value = "";
            imprisonmentDateDiv.classList.add('hidden'); // Hide imprisonment date input
            imprisonmentDateEditInput.value = '';
        }

        async function confirmDeletePrisoner(prisoner) {
            showDialog(
                `정말로 ${prisoner.personInfo} (${prisoner.championInfo}) 수감자 정보를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`,
                async () => {
                    try {
                        if (!prisonersCollectionRef) throw new Error("DB 연결이 초기화되지 않았습니다.");
                        await deleteDoc(doc(prisonersCollectionRef, prisoner.id));
                        await syncToPublicRoster(prisoner.id, null, true); 
                        showDialog("수감자 정보가 성공적으로 삭제되었습니다.");
                        clearSearchResults();
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                        showDialog(`삭제 중 오류 발생: ${error.message}`);
                    }
                },
                true, 
                "삭제",
                "취소"
            );
        }
        
        function clearSearchResults() {
            statusMessage.textContent = "조회할 수감자 정보를 입력하고 '정보 조회' 버튼을 누르세요.";
            prisonerDetailsContent.innerHTML = '';
            actionsBar.innerHTML = '';
            levelArrow.style.display = 'none';
            championImageEl.classList.add('hidden');
            championImageEl.src = 'https://placehold.co/40x40/transparent/transparent?text=';
        }
        
        dbInfoBtn.addEventListener('click', () => {
            showDialog("이 시스템에 저장된 모든 정보는 안전한 원격 데이터베이스(Firebase Firestore)에 보관됩니다. 개인 정보는 현재 세션 또는 계정에 귀속되어 관리되며, 공개 명단 정보는 모든 방문자가 조회할 수 있습니다. 실제 데이터베이스 콘솔 접근은 관리자만 가능합니다.");
        });

        viewRosterBtn.addEventListener('click', async () => {
            if (!publicRosterCollectionRef) {
                showDialog("공개 명단 기능을 사용할 수 없습니다. 잠시 후 다시 시도해주세요.");
                return;
            }
            rosterTableContainer.innerHTML = "<p>명단을 불러오는 중입니다...</p>";
            rosterModal.classList.remove('hidden');
            try {
                const querySnapshot = await getDocs(publicRosterCollectionRef);
                if (querySnapshot.empty) {
                    rosterTableContainer.innerHTML = "<p>등록된 수감자가 없습니다.</p>";
                    return;
                }
                
                let tableHTML = '<table class="roster-table"><thead><tr><th>이름</th><th>챔피언</th><th>OP Score</th><th>KDA</th><th>수감일</th><th>층수</th><th>상태</th></tr></thead><tbody>';
                const today = new Date();
                const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                querySnapshot.forEach(docSnap => {
                    const prisoner = docSnap.data();
                    const imprisonmentDate = prisoner.imprisonmentDate?.toDate();
                    let statusText = "정보 없음";
                    if (imprisonmentDate) {
                        const releaseDate = new Date(imprisonmentDate.getTime());
                        releaseDate.setDate(imprisonmentDate.getDate() + prisoner.durationDays);
                        const releaseDateOnly = new Date(releaseDate.getFullYear(), releaseDate.getMonth(), releaseDate.getDate());
                        if (todayDateOnly > releaseDateOnly) {
                            statusText = `${formatDate(releaseDate)} 석방됨`;
                        } else {
                            statusText = `${formatDate(releaseDate)} 석방 예정 (B${prisoner.prisonLevel})`;
                        }
                    }

                    tableHTML += `<tr>
                        <td>${prisoner.personInfo}</td>
                        <td>${prisoner.championInfo}</td>
                        <td>${prisoner.opggScore}</td>
                        <td>${prisoner.kda || 'N/A'}</td>
                        <td>${formatDate(imprisonmentDate)}</td>
                        <td>B${prisoner.prisonLevel}</td>
                        <td>${statusText}</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                rosterTableContainer.innerHTML = tableHTML;

            } catch (error) {
                console.error("Error fetching public roster: ", error);
                rosterTableContainer.innerHTML = "<p>명단 로딩 중 오류가 발생했습니다.</p>";
            }
        });
        closeRosterModalBtn.addEventListener('click', () => rosterModal.classList.add('hidden'));

        document.querySelectorAll('#prisonTowerVisual .floor[data-level]').forEach(floorDiv => {
            floorDiv.addEventListener('click', async () => {
                if (!publicRosterCollectionRef) {
                    showDialog("층별 수감자 정보를 불러올 수 없습니다. DB 연결을 확인하세요.");
                    return;
                }
                const level = parseInt(floorDiv.dataset.level);
                floorInmatesTitle.innerHTML = `<i class="fas fa-door-closed mr-2"></i> 지하 ${level}층 현재 수감자`;
                floorInmatesTableContainer.innerHTML = "<p>명단을 불러오는 중입니다...</p>";
                floorInmatesModal.classList.remove('hidden');

                try {
                    const q = query(publicRosterCollectionRef, where("prisonLevel", "==", level));
                    const querySnapshot = await getDocs(q);
                    
                    let inmatesOnFloorHTML = '<table class="roster-table"><thead><tr><th>사람 정보</th><th>사용 챔피언</th><th>상태 (석방 예정일)</th></tr></thead><tbody>';
                    let activeInmatesCount = 0;
                    const today = new Date();
                    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                    querySnapshot.forEach(docSnap => {
                        const prisoner = docSnap.data();
                        const imprisonmentDate = prisoner.imprisonmentDate?.toDate();
                        if (imprisonmentDate) {
                            const releaseDate = new Date(imprisonmentDate.getTime());
                            releaseDate.setDate(imprisonmentDate.getDate() + prisoner.durationDays);
                            const releaseDateOnly = new Date(releaseDate.getFullYear(), releaseDate.getMonth(), releaseDate.getDate());

                            if (todayDateOnly <= releaseDateOnly) { 
                                activeInmatesCount++;
                                inmatesOnFloorHTML += `<tr>
                                    <td>${prisoner.personInfo}</td>
                                    <td>${prisoner.championInfo}</td>
                                    <td>${formatDate(releaseDate)} 석방 예정</td>
                                </tr>`;
                            }
                        }
                    });

                    if (activeInmatesCount === 0) {
                        floorInmatesTableContainer.innerHTML = "<p>현재 이 층에는 수감자가 없습니다.</p>";
                    } else {
                        inmatesOnFloorHTML += '</tbody></table>';
                        floorInmatesTableContainer.innerHTML = inmatesOnFloorHTML;
                    }
                } catch (error) {
                    console.error(`Error fetching inmates for floor ${level}: `, error);
                    floorInmatesTableContainer.innerHTML = "<p>층별 수감자 정보 로딩 중 오류가 발생했습니다.</p>";
                }
            });
        });
        closeFloorInmatesModalBtn.addEventListener('click', () => floorInmatesModal.classList.add('hidden'));

        backgroundMusic.volume = 0.05; 
        playPauseBtn.addEventListener('click', () => {
            if (backgroundMusic.paused) {
                backgroundMusic.play().catch(e => console.error("Audio play error:", e));
                playPauseBtn.innerHTML = pauseIcon;
            } else {
                backgroundMusic.pause();
                playPauseBtn.innerHTML = playIcon;
            }
        });
        
        document.body.addEventListener('click', () => {
            if (backgroundMusic.paused && playPauseBtn.innerHTML === playIcon) {
                // Autoplay policy compliance
            }
        }, { once: true });

        statusMessage.textContent = "조회할 수감자 정보를 입력하고 '정보 조회' 버튼을 누르세요.";
    </script>
</body>
</html>
